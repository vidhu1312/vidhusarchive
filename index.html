<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=820, initial-scale=1.0" />
<title>Carpet Warpet</title>
<style>
  body {
    margin: 0;
    background: #e7e7e7;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #ipad-frame {
    background: white;
    width: 820px;
    height: 1180px;
    border-radius: 50px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.17), 0 4px 8px rgba(0,0,0,0.09);
    border: 8px solid #ddd;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
  }
  #onboarding, #carpet-interact { width:100%; height:100%; }
  #onboarding {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
  }
  #carpet-options {
    display: flex;
    gap: 30px;
    margin-top: 32px;
  }
  .carpet-option {
    border: 2px solid #bbb;
    border-radius: 18px;
    overflow: hidden;
    width: 180px;
    height: 180px;
    cursor: pointer;
    background: #fafafa;
    transition: box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    object-fit: cover;
  }
  .carpet-option:active {
    box-shadow: 0 0 0 4px #6cf;
  }
  #onboarding h1 {
    font-size: 2.1em;
    margin-bottom: 0.6em;
    color: #13406d;
  }
  #onboarding .desc {
    color: #565656;
    margin-bottom: 0.7em;
  }
  #carpet-interact {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100%;
    padding-top: 28px;
  }
  #container {
    position: relative;
    border: 1px solid #ccc;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    border-radius: 12px;
    margin-top: 16px;
    background: #f0f0f0;
  }
  canvas {
    display: block;
    cursor: pointer;
    border-radius: 12px;
  }
  #overlay {
    pointer-events: none;
  }
  #resetBtn {
    padding: 10px 38px;
    font-size: 18px;
    margin-bottom: 9px;
    border-radius: 10px;
    border: none;
    background: #3495ed;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.18s;
  }
  #resetBtn:active {
    background: #277ad5;
  }
</style>
</head>
<body>
<div id="ipad-frame">
  <div id="onboarding">
    <h1>Welcome to Carpet Warpet</h1>
    <div class="desc">Choose your carpet:</div>
    <div id="carpet-options">
      <img src="top.png" class="carpet-option" alt="carpet 1" data-img="top.png">
      <img src="bottom.png" class="carpet-option" alt="carpet 2" data-img="bottom.png">
      <img src="middle.png" class="carpet-option" alt="carpet 3" data-img="middle.png">
    </div>
  </div>
  <div id="carpet-interact" style="display:none;">
    <button id="resetBtn">Reset</button>
    <span style="font-size: 15px; color: #555;margin-bottom:12px;">Hold Shift to restore | Two fingers on touch</span>
    <div id="container">
      <canvas id="baseCanvas"></canvas>
      <canvas id="overlay"></canvas>
    </div>
  </div>
</div>
<script>
  const onboarding = document.getElementById('onboarding');
  const interact = document.getElementById('carpet-interact');
  const baseCanvas = document.getElementById('baseCanvas');
  const overlay = document.getElementById('overlay');
  const baseCtx = baseCanvas.getContext('2d');
  const overlayCtx = overlay.getContext('2d');
  let topImage = null;
  let isDrawing = false;
  let lastX = 0, lastY = 0;

  // Onboarding selection logic
  document.querySelectorAll('.carpet-option').forEach(item => {
    item.onclick = () => {
      onboarding.style.display = 'none';
      interact.style.display = 'flex';
      startWithCarpet(item.getAttribute('data-img'));
    };
  });

  function startWithCarpet(imgPath) {
    topImage = new Image();
    topImage.src = imgPath;
    topImage.onload = () => { init(); };
    topImage.onerror = () => {
      baseCanvas.width = 600; baseCanvas.height = 400; overlay.width = 600; overlay.height = 400;
      baseCtx.fillStyle = '#8B4513'; baseCtx.fillRect(0, 0, baseCanvas.width, baseCanvas.height);
      baseCtx.fillStyle = 'white';
      baseCtx.font = '20px Arial'; baseCtx.textAlign = 'center';
      baseCtx.fillText('Cannot load ' + imgPath, baseCanvas.width/2, baseCanvas.height/2);
    };
  }

  function init() {
    baseCanvas.width = topImage.width;
    baseCanvas.height = topImage.height;
    overlay.width = topImage.width;
    overlay.height = topImage.height;
    baseCtx.drawImage(topImage, 0, 0);
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  }

  function drawBrush(x, y, reverse = false) {
    const radius = 15, grainCount = 40;
    if (!reverse) { // Fade
      overlayCtx.save();
      overlayCtx.filter = 'brightness(1.8) contrast(0.5)';
      overlayCtx.globalCompositeOperation = 'source-over';
      for (let i = 0; i < grainCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * radius;
        const px = x + Math.cos(angle) * distance;
        const py = y + Math.sin(angle) * distance;
        const opacity = 0.3 + Math.random() * 0.4;
        overlayCtx.globalAlpha = opacity;
        overlayCtx.drawImage(topImage, 
          px - 3, py - 3, 6, 6,
          px - 3, py - 3, 6, 6
        );
      }
      overlayCtx.globalAlpha = 0.2;
      overlayCtx.drawImage(topImage,
        x - radius * 0.5, y - radius * 0.5, radius, radius,
        x - radius * 0.5, y - radius * 0.5, radius, radius
      );
      overlayCtx.restore();
    } else { // Restore
      overlayCtx.save();
      overlayCtx.globalCompositeOperation = 'destination-out';
      for (let i = 0; i < grainCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const distance = Math.random() * radius;
        const px = x + Math.cos(angle) * distance;
        const py = y + Math.sin(angle) * distance;
        const opacity = 0.3 + Math.random() * 0.4;
        overlayCtx.globalAlpha = opacity;
        overlayCtx.beginPath();
        overlayCtx.arc(px, py, 2 + Math.random() * 2, 0, Math.PI * 2);
        overlayCtx.fill();
      }
      overlayCtx.globalAlpha = 0.2;
      overlayCtx.beginPath();
      overlayCtx.arc(x, y, radius * 0.5, 0, Math.PI * 2);
      overlayCtx.fill();
      overlayCtx.restore();
    }
  }

  baseCanvas.addEventListener('mousedown', (e) => {
    isDrawing = true;
    const rect = baseCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left, y = e.clientY - rect.top;
    lastX = x; lastY = y;
    drawBrush(x, y, e.shiftKey);
  });
  baseCanvas.addEventListener('mousemove', (e) => {
    if (!isDrawing) return;
    const rect = baseCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    drawBrush(x, y, e.shiftKey);
    lastX = x;
    lastY = y;
  });
  baseCanvas.addEventListener('mouseup', () => { isDrawing = false; });
  baseCanvas.addEventListener('mouseleave', () => { isDrawing = false; });

  // Touch support
  baseCanvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    isDrawing = true;
    const rect = baseCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    lastX = x;
    lastY = y;
    drawBrush(x, y, e.touches.length >= 2);
  });
  baseCanvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!isDrawing) return;
    const rect = baseCanvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    drawBrush(x, y, e.touches.length >= 2);
    lastX = x;
    lastY = y;
  });
  baseCanvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    isDrawing = false;
  });

  // Reset button
  document.getElementById('resetBtn').addEventListener('click', () => {
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
  });
</script>
</body>
</html>
