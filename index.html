<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Carpet Warpet</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
margin: 0;
padding: 0;
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
background: #d4d1cd;
font-family: 'Georgia', serif;
}

#ipadFrame {
width: 820px;
height: 1180px;
background: #1a1a1a;
border-radius: 40px;
padding: 60px 20px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
position: relative;
}

#ipadFrame::before {
content: '';
position: absolute;
top: 20px;
left: 50%;
transform: translateX(-50%);
width: 80px;
height: 6px;
background: #333;
border-radius: 3px;
}

#screen {
width: 100%;
height: 100%;
background: white;
border-radius: 20px;
overflow: hidden;
position: relative;
transition: background-color 0.3s ease, color 0.3s ease;
}

#screen.dark-mode {
background: #1a1a1a;
color: white;
}

.page {
display: none;
width: 100%;
height: 100%;
padding: 40px;
}

/* Ensure the initial page is shown by default */
.page.active { 
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
}

#onboarding {
text-align: center;
}

#onboarding h1 {
font-size: 72px;
font-weight: 400;
margin-bottom: 60px;
color: #1a1a1a;
}

.carpet-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 20px;
margin-top: 40px;
}

.carpet-option {
width: 180px;
height: 240px;
border: 3px solid #ddd;
border-radius: 16px;
cursor: pointer;
transition: all 0.3s;
overflow: hidden;
position: relative;
}

.carpet-option:hover {
border-color: #667eea;
transform: scale(1.05);
}

.carpet-option img {
width: 100%;
height: 100%;
object-fit: cover;
display: block;
}

.carpet-label {
margin-top: 10px;
font-size: 18px;
color: #000;
}

#carpetPage {
padding: 20px;
justify-content: flex-start;
}

.mode-toggle-container {
display: flex;
justify-content: center;
width: 100%;
margin-bottom: 25px;
}

#modeBtn {
padding: 16px 40px;
font-size: 20px;
font-weight: 600;
cursor: pointer;
border: none;
border-radius: 16px;
font-family: 'Georgia', serif;
transition: all 0.3s;
background: linear-gradient(135deg, #d6c9b4 0%, #b8a78b 100%);
color: #3a3a3a;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
letter-spacing: 0.5px;
}

#modeBtn:hover {
transform: translateY(-2px);
box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
background: linear-gradient(135deg, #c9bca7 0%, #a89a7e 100%);
}

#modeBtn:active {
transform: translateY(0);
}

.controls {
display: flex;
gap: 15px;
margin-bottom: 20px;
width: 100%;
justify-content: space-between;
align-items: center;
}

.btn {
padding: 12px 24px;
font-size: 16px;
cursor: pointer;
border: none;
border-radius: 12px;
font-family: 'Georgia', serif;
transition: all 0.2s;
background: #667eea;
color: white;
}

.btn:hover {
background: #5568d3;
transform: translateY(-2px);
}

.btn-secondary {
background: #f0f0f0;
color: #000;
}

.btn-secondary:hover {
background: #e0e0e0;
}

#screen.dark-mode .btn-secondary {
background: #333;
color: white;
}

#screen.dark-mode .btn-secondary:hover {
background: #444;
}

.instructions {
font-size: 14px;
color: #000;
}

#screen.dark-mode .instructions {
color: #ccc;
}

#container {
position: relative;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
border-radius: 12px;
overflow: hidden;
}

canvas {
display: block;
cursor: crosshair;
}

#overlay {
position: absolute;
top: 0;
left: 0;
/* REMOVED pointer-events: none; so we can draw on it */
}
</style>
</head>
<body>
<div id="ipadFrame">
<div id="screen">
<div id="onboarding" class="page active">
<h1>Carpet Warpet</h1>
<p style="font-size: 20px; color: #000; margin-bottom: 20px;">Choose your carpet</p>
<div class="carpet-grid">
<div class="carpet-option" data-carpet="top">
<img src="top.png" alt="Top Carpet" onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #e0c3a5 0%, #c9a582 100%)';">
</div>
<div class="carpet-option" data-carpet="middle">
<img src="middle.png" alt="Middle Carpet" onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #b5926a 0%, #8b6f47 100%)';">
</div>
<div class="carpet-option" data-carpet="bottom">
<img src="bottom.png" alt="Bottom Carpet" onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #6b4423 0%, #4a2f1a 100%)';">
</div>
</div>
</div>

<div id="carpetPage" class="page">
<div class="mode-toggle-container">
<button id="modeBtn" class="btn">Restore Mode</button>
</div>
<div class="controls">
<button id="backBtn" class="btn btn-secondary">← Back</button>
<span class="instructions">Draw to fade • Switch mode to restore</span>
<button id="resetBtn" class="btn btn-secondary">Reset</button>
</div>
<div id="container">
<canvas id="baseCanvas"></canvas>
<canvas id="overlay"></canvas>
</div>
</div>
</div>
</div>

<script>
const container = document.getElementById('container');
const baseCanvas = document.getElementById('baseCanvas');
const overlay = document.getElementById('overlay');
const baseCtx = baseCanvas.getContext('2d');
const overlayCtx = overlay.getContext('2d');
const onboardingPage = document.getElementById('onboarding');
const carpetPage = document.getElementById('carpetPage');
const screen = document.getElementById('screen');
const instructionsSpan = document.querySelector('.instructions');

let currentCarpet = null;
let topImage = new Image();
let isDrawing = false;
let fadeMode = true;

// --- Helper Functions ---

function fillOverlayWithFade() {
    overlayCtx.globalCompositeOperation = "source-over";
    overlayCtx.fillStyle = "rgba(255, 255, 255, 0.5)"; 
    overlayCtx.fillRect(0, 0, overlay.width, overlay.height);
}

// --- Carpet Selection and Initialization ---

document.querySelectorAll('.carpet-option').forEach(option => {
    option.addEventListener('click', () => {
        const carpetType = option.dataset.carpet;
        loadCarpet(carpetType);
    });
});

function loadCarpet(carpetType) {
    fadeMode = true;
    screen.classList.remove('dark-mode');
    document.getElementById('modeBtn').textContent = 'Restore Mode';
    instructionsSpan.textContent = "Draw to fade • Switch mode to restore";

    currentCarpet = carpetType;
    topImage = new Image();
    topImage.crossOrigin = "anonymous";
    topImage.src = `${carpetType}.png`;

    topImage.onload = () => {
        init();
        onboardingPage.classList.remove('active');
        carpetPage.classList.add('active');
    };

    topImage.onerror = () => {
        console.error(`Failed to load ${carpetType}.png`);
        
        // Fallback initialization
        baseCanvas.width = 700;
        baseCanvas.height = 900;
        overlay.width = 700;
        overlay.height = 900;

        // Draw fallback base pattern
        baseCtx.fillStyle = carpetType === 'top' ? '#c9a582' : carpetType === 'middle' ? '#8b6f47' : '#4a2f1a';
        baseCtx.fillRect(0, 0, baseCanvas.width, baseCanvas.height);
        
        baseCtx.fillStyle = 'white';
        baseCtx.font = '20px Georgia';
        baseCtx.textAlign = 'center';
        baseCtx.fillText(`Draw on me! (${carpetType}.png not found)`, baseCanvas.width/2, 50);

        fillOverlayWithFade();

        onboardingPage.classList.remove('active');
        carpetPage.classList.add('active');
    };
}

function init() {
    const maxWidth = 700;
    const maxHeight = 900;

    let scale = Math.min(maxWidth / topImage.width, maxHeight / topImage.height);

    baseCanvas.width = topImage.width * scale;
    baseCanvas.height = topImage.height * scale;
    overlay.width = baseCanvas.width;
    overlay.height = baseCanvas.height;

    baseCtx.drawImage(topImage, 0, 0, baseCanvas.width, baseCanvas.height);
    
    fillOverlayWithFade();
    
    // Ensure pointer events are active on the overlay
    overlay.style.pointerEvents = 'auto'; 
}

function getCanvasCoords(e) {
    const rect = overlay.getBoundingClientRect();
    if (e.touches) {
        return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
        };
    }
    return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
    };
}

// --- Drawing Logic with Rough Edges ---

function drawBrush(x, y) {
    const radius = 25;
    const edgeRoughness = 20;
    let brushColor = 'rgba(0, 0, 0, 1)';

    overlayCtx.save();
    
    if (fadeMode) {
        overlayCtx.globalCompositeOperation = "destination-out";
        instructionsSpan.textContent = "Draw to fade • Switch mode to restore"; 
    } else {
        overlayCtx.globalCompositeOperation = "source-over";
        brushColor = 'rgba(255, 255, 255, 0.5)'; 
        instructionsSpan.textContent = "Draw to restore • Switch mode to fade"; 
    }

    // 1. Draw a main circular shape
    overlayCtx.fillStyle = brushColor;
    overlayCtx.beginPath();
    overlayCtx.arc(x, y, radius * 0.9, 0, Math.PI * 2); 
    overlayCtx.fill();

    // 2. Add rough edges
    for (let i = 0; i < edgeRoughness; i++) {
        const angle = Math.random() * Math.PI * 2;
        const dist = radius * (0.7 + Math.random() * 0.6); 
        const nx = x + Math.cos(angle) * dist;
        const ny = y + Math.sin(angle) * dist;
        
        const size = 1 + Math.random() * 2;
        overlayCtx.fillRect(nx, ny, size, size);
    }
    
    overlayCtx.restore();
}

function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;
    const coords = getCanvasCoords(e);
    drawBrush(coords.x, coords.y);
}

function draw(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const coords = getCanvasCoords(e);
    drawBrush(coords.x, coords.y);
}

function stopDrawing(e) {
    e.preventDefault();
    isDrawing = false;
}

// Attach all events to the #overlay canvas
overlay.addEventListener('mousedown', startDrawing);
overlay.addEventListener('mousemove', draw);
overlay.addEventListener('mouseup', stopDrawing);
overlay.addEventListener('mouseleave', stopDrawing);

// Touch events
overlay.addEventListener('touchstart', startDrawing);
overlay.addEventListener('touchmove', draw);
overlay.addEventListener('touchend', stopDrawing);

// --- Buttons ---

document.getElementById('resetBtn').addEventListener('click', () => {
    fillOverlayWithFade();
    if (fadeMode) {
        instructionsSpan.textContent = "Draw to fade • Switch mode to restore";
    } else {
        instructionsSpan.textContent = "Draw to restore • Switch mode to fade";
    }
});

document.getElementById('modeBtn').addEventListener('click', () => {
    fadeMode = !fadeMode;
    document.getElementById('modeBtn').textContent = fadeMode ? 'Restore Mode' : 'Fade Mode'; 

    if (fadeMode) {
        screen.classList.remove('dark-mode');
        instructionsSpan.textContent = "Draw to fade • Switch mode to restore";
    } else {
        screen.classList.add('dark-mode');
        instructionsSpan.textContent = "Draw to restore • Switch mode to fade";
    }
});

document.getElementById('backBtn').addEventListener('click', () => {
    carpetPage.classList.remove('active');
    onboardingPage.classList.add('active');
    overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
    screen.classList.remove('dark-mode');
});
</script>
</body>
</html>
